trigger:
- main
- develop

pr:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Default environment variables for SQL Server connection
  MSSQL_HOST: localhost
  MSSQL_PORT: 1433
  MSSQL_DATABASE: testdb
  MSSQL_USER: sa
  MSSQL_ENCRYPT: true
  MSSQL_TRUST_CERT: true
  # SQL Server password comes from variable group or pipeline variables

stages:
- stage: Test
  displayName: 'Run Tests'
  jobs:
  - job: TestSQLServer
    displayName: 'Test against SQL Server'
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          SA_PASSWORD: $(SA_PASSWORD)
          ACCEPT_EULA: Y
        ports:
          - "1433:1433"
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $(SA_PASSWORD) -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - checkout: self
      submodules: true
      displayName: 'Checkout code with submodules'

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: 'Setup Node.js'

    - task: Npm@1
      inputs:
        command: 'ci'
      displayName: 'Install dependencies'

    - script: npm run build
      displayName: 'Build project'

    - script: |
        # Wait for SQL Server to be ready
        for i in {1..30}; do
          if sqlcmd -S localhost -U sa -P "$(SA_PASSWORD)" -Q "SELECT 1" > /dev/null 2>&1; then
            echo "SQL Server is ready"
            break
          fi
          echo "Waiting for SQL Server... ($i/30)"
          sleep 2
        done
        
        # Create test database
        sqlcmd -S localhost -U sa -P "$(SA_PASSWORD)" -Q "CREATE DATABASE testdb"
        echo "Test database created successfully"
      displayName: 'Setup SQL Server database'
      env:
        SA_PASSWORD: $(SA_PASSWORD)

    - script: npx tsx src/cli.ts test ./sqlonfhir/tests
      displayName: 'Run tests'
      env:
        MSSQL_PASSWORD: $(SA_PASSWORD)

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/test-results.xml'
        testRunTitle: 'SQL on FHIR Tests'
      displayName: 'Publish test results'

    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        pathToPublish: 'test-report.json'
        artifactName: 'test-reports'
      displayName: 'Upload test artifacts'

- stage: TestMatrix
  displayName: 'Test Multiple SQL Server Versions'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  dependsOn: Test
  
  jobs:
  - job: TestSQLServerVersions
    displayName: 'Test SQL Server'
    strategy:
      matrix:
        SQLServer2017:
          SqlServerVersion: '2017-latest'
        SQLServer2019:
          SqlServerVersion: '2019-latest'
        SQLServer2022:
          SqlServerVersion: '2022-latest'
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:$(SqlServerVersion)
        env:
          SA_PASSWORD: TestPassword123!
          ACCEPT_EULA: Y
        ports:
          - "1433:1433"

    steps:
    - checkout: self
      submodules: true

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'

    - task: Npm@1
      inputs:
        command: 'ci'

    - script: npm run build

    - script: |
        sleep 30
        sqlcmd -S localhost -U sa -P "TestPassword123!" -Q "CREATE DATABASE testdb"

    - script: npx tsx src/cli.ts test ./sqlonfhir/tests
      env:
        MSSQL_PASSWORD: TestPassword123!