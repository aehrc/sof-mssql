name: Claude - Fix failed workflow

on:
  workflow_run:
    workflows: [Build and test]
    types: [completed]
    branches:
      - 'claude/**'

jobs:
  claude-autofix:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.workflow_run.head_branch }}
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install dependencies
        run: npm ci
        
      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          additional_permissions: |
            actions: read
          claude_args: |
            --model claude-sonnet-4-5
            --mcp-config '{"mcpServers": {"github": {"type": "http", "url": "https://api.githubcopilot.com/mcp/", "headers": {"Authorization": "Bearer ${{ secrets.GITHUB_TOKEN }}"}}}}'
            --allowedTools "Bash(npm install),Bash(npm ci),Bash(npm run build),Bash(npm run test:*),Bash(npm run lint:*),Bash(npm run format),Bash(npm run format:check),Bash(git diff:*),WebFetch(domain:sql-on-fhir.org),WebFetch(domain:learn.microsoft.com),mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,Edit,Write"
          prompt: |
            Please review any errors or failures in the latest "Build and test" workflow run for the 
            branch of the PR and make fixes necessary to satisfy the goals of the pull request. 
            Workflow run: ${{ github.event.workflow_run.html_url }}
