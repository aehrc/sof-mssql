name: Claude - Fix Failed Workflow

on:
  workflow_run:
    workflows: ["Build and test"]
    types: [completed]

jobs:
  claude-autofix:
    if: github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-5
            --allowedTools "Bash(npm install),Bash(npm run build),Bash(npm run test:*),Bash(npm run lint:*),Bash(npm run format)"
          context: Please review any errors or failures in the latest "Build and Test" workflow run for the branch of the PR and make fixes necessary to satisfy the goals of the pull request. Workflow run: ${{ github.event.workflow_run.html_url }}